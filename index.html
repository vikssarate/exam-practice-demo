<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />
<title>Exam Practice Demo</title>
<style>
:root{--bg:#f6f9ff;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e5edf7;--accent:#1565c0;--good:#1e8e3e;--bad:#c62828;--radius:14px;--shadow:0 10px 30px rgba(0,0,0,.06)}
@media(prefers-color-scheme:dark){:root{--bg:#0b0f14;--card:#121923;--text:#eaf2ff;--muted:#8aa0b7;--border:#1e2a3a;--accent:#5ab0ff;--shadow:0 12px 34px rgba(0,0,0,.35)}}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
header{position:sticky;top:0;background:color-mix(in oklab,var(--bg) 85%,transparent);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);z-index:5}
.top{display:flex;align-items:center;justify-content:space-between}
h1{margin:0;font-size:18px}
.grid{display:grid;gap:14px}
@media(min-width:1000px){.grid{grid-template-columns:2fr 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
button{border:1px solid var(--border);border-radius:12px;background:var(--card);padding:10px 12px;color:var(--text);cursor:pointer}
button.primary{background:var(--accent);color:#fff;border-color:transparent;font-weight:700}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:color-mix(in oklab,var(--accent),white 18%);color:#fff;font-size:12px}
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
.options{display:grid;gap:10px}
@media(min-width:700px){.options{grid-template-columns:1fr}}
.opt{display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:10px;padding:10px;cursor:pointer}
.opt.selected{outline:2px solid var(--accent)}
.palette{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;margin-top:14px}
.palette button{padding:8px;border-radius:8px}
.muted{color:var(--muted);font-size:12px}
.timer{font-weight:700}
hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.qtitle{font-weight:800;margin:0 0 8px 0}
#qText img{max-width:100%;height:auto;display:block;margin-top:8px;border-radius:8px}
</style>
</head>
<body>
<header>
  <div class="wrap top">
    <h1>üìù Exam Practice Demo</h1>
    <div class="timer" id="timer">--:--:--</div>
  </div>
</header>

<main class="wrap grid">
  <section class="card">
    <div id="testList">
      <h2>Select a Test</h2>
      <div id="tests"></div>
      <p class="muted">Features: timer, negative marking, palette, review, export. Works offline.</p>
    </div>

    <div id="examArea" style="display:none">
      <div class="badge" id="testTitle"></div>
      <div class="muted">Remaining: <span id="remain"></span></div>
      <hr>
      <h3 class="qtitle" id="qHead">Q1.</h3>
      <div id="qText"></div>
      <div class="options" id="optWrap"></div>

      <div class="controls">
        <button id="clearBtn">Clear</button>
        <button id="markBtn">Mark for Review</button>
        <button id="prevBtn">Prev</button>
        <button id="nextBtn">Save & Next</button>
        <button id="submitBtn" class="primary">Submit</button>
      </div>

      <h3>Question Palette</h3>
      <div class="palette" id="palette"></div>
    </div>

    <div id="resultArea" style="display:none">
      <h2>Result</h2>
      <div id="resultSummary"></div>
      <button id="reviewBtn" class="primary">Review Answers</button>
      <button id="exportBtn">Export Result JSON</button>
    </div>
  </section>

  <aside class="card">
    <h3>Test Info</h3>
    <div id="info"></div>
  </aside>
</main>

<script>
/* ====== Data loading ====== */
const state = {
  tests: [],
  activeTest: null,
  idx: 0,
  answers: {}, // qid -> option index
  review: {},  // qid -> true
  startTs: null,
  endTs: null,
  timer: null
};

async function loadQuestions() {
  const res = await fetch('questions.json?v=img9');
  const data = await res.json();
  // support both {tests:[...]} and simple [{...}] shapes
  state.tests = Array.isArray(data) ? [{id:'demo',title:'Demo',durationMinutes:30,negative:0.25,questions:data}] : data.tests;
  renderTestList();
}

/* ====== UI refs ====== */
const $ = s => document.querySelector(s);
const testsEl = $('#tests');
const testList = $('#testList');
const examArea = $('#examArea');
const resultArea = $('#resultArea');
const qHead = $('#qHead');
const qText = $('#qText');
const optWrap = $('#optWrap');
const palette = $('#palette');
const testTitle = $('#testTitle');
const info = $('#info');
const timerEl = $('#timer');
const remain = $('#remain');

/* ====== Helpers ====== */
function fmt(t){return String(t).padStart(2,'0')}
function fmtHMS(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=Math.floor(sec%60); return `${fmt(h)}:${fmt(m)}:${fmt(s)}` }

function startTest(t) {
  state.activeTest = t;
  state.idx = 0;
  state.answers = {};
  state.review = {};
  state.startTs = Date.now();
  state.endTs = state.startTs + t.durationMinutes * 60 * 1000;

  testList.style.display='none';
  resultArea.style.display='none';
  examArea.style.display='block';

  testTitle.textContent = t.title;
  info.innerHTML = `<p><b>Negative Marking:</b> -${t.negative}</p><p><b>Marks / correct:</b> 1 (or per question)</p>`;
  tickTimer();
  state.timer = setInterval(tickTimer, 1000);
  renderQuestion();
  renderPalette();
}

function tickTimer(){
  if(!state.activeTest) return;
  const left = Math.max(0, Math.floor((state.endTs - Date.now())/1000));
  timerEl.textContent = fmtHMS(left);
  remain.textContent = fmtHMS(left);
  if(left===0){ submitTest(); }
}

function currentQuestion(){ return state.activeTest.questions[state.idx]; }

function renderQuestion(){
  const q = currentQuestion();
  qHead.textContent = `Q${state.idx+1}.`;
  // IMPORTANT: render HTML, not plain text
  qText.innerHTML = q.text;                       // ‚Üê renders <img>, <sup>, etc.

  optWrap.innerHTML = '';
  q.options.forEach((opt,i)=>{
    const btn = document.createElement('button');
    btn.className = 'opt';
    btn.type = 'button';
    // render option as HTML too (allows image options)
    btn.innerHTML = opt;                          // ‚Üê key change
    if(state.answers[q.id] === i) btn.classList.add('selected');
    btn.onclick = ()=>{ state.answers[q.id]=i; renderQuestion(); renderPalette(); };
    optWrap.appendChild(btn);
  });
}

function renderPalette(){
  const list = state.activeTest.questions;
  palette.innerHTML='';
  list.forEach((q,i)=>{
    const b=document.createElement('button');
    const answered = state.answers[q.id] != null;
    b.textContent = i+1;
    if(answered) b.style.background = 'rgba(21,101,192,.15)';
    if(state.review[q.id]) b.style.outline = '2px solid #f59e0b';
    b.onclick=()=>{ state.idx=i; renderQuestion(); };
    palette.appendChild(b);
  });
}

/* ====== Controls ====== */
$('#prevBtn').onclick = ()=>{ if(state.idx>0){ state.idx--; renderQuestion(); } };
$('#nextBtn').onclick = ()=>{ if(state.idx < state.activeTest.questions.length-1){ state.idx++; renderQuestion(); } };
$('#clearBtn').onclick = ()=>{ const q=currentQuestion(); delete state.answers[q.id]; renderQuestion(); renderPalette(); };
$('#markBtn').onclick = ()=>{ const q=currentQuestion(); state.review[q.id]=!state.review[q.id]; renderPalette(); };
$('#submitBtn').onclick = ()=> submitTest();

function submitTest(){
  clearInterval(state.timer);
  const t = state.activeTest;
  const neg = t.negative || 0;
  let score = 0, correct=0, wrong=0, unattempt=0;
  t.questions.forEach(q=>{
    const a = state.answers[q.id];
    if(a==null){ unattempt++; return; }
    if(a === q.answer){ correct++; score += (q.marks||1); }
    else { wrong++; score -= neg; }
  });
  const total = t.questions.length;
  const summary = `
    <p><b>Score:</b> ${score.toFixed(2)} / ${total}</p>
    <p><b>Correct:</b> ${correct}, <b>Wrong:</b> ${wrong}, <b>Unattempted:</b> ${unattempt}</p>
    <p><b>Time:</b> ${fmtHMS(Math.floor((Date.now()-state.startTs)/1000))}</p>
  `;
  $('#resultSummary').innerHTML = summary;
  examArea.style.display='none';
  resultArea.style.display='block';
}

$('#reviewBtn').onclick = ()=>{
  // simple review: go back and allow navigation with answers highlighted
  state.idx = 0;
  examArea.style.display='block';
  resultArea.style.display='none';
  renderQuestion();
  renderPalette();
};

$('#exportBtn').onclick = ()=>{
  const payload = {
    test: state.activeTest?.id,
    answers: state.answers,
    review: state.review,
    ts: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='exam_result.json'; a.click(); URL.revokeObjectURL(url);
};

/* ====== Test list ====== */
function renderTestList(){
  testsEl.innerHTML='';
  state.tests.forEach(t=>{
    const b=document.createElement('button');
    b.className='opt';
    b.innerHTML = `<div><b>${t.title}</b><div class="muted">${t.durationMinutes} min ‚Äî ${t.questions.length} Q</div></div>`;
    b.onclick=()=>startTest(t);
    testsEl.appendChild(b);
  });
}

loadQuestions();

// Register SW (PWA)
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }
</script>
</body>
</html>
